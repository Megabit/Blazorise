import{j as m,l as u,k as S,i as f,d as T,D as c,a as p,I as g}from"./vidstack-9sLhInZa.js";import{g as b}from"./vidstack-CCLEdTWF.js";const A=Symbol(0),E=Symbol(0),w=Symbol(0),O=Symbol(0),x=Symbol(0),N=Symbol(0),k=Symbol(0),a={crossOrigin:A,readyState:E,updateActiveCues:w,canLoad:O,onModeChange:x,native:N,nativeHLS:k};function M(r,t){for(let s=0,e=r.length;s<e;s++)if(l(r[s],t))return r[s];return null}function l(r,t){return t>=r.startTime&&t<r.endTime}function v(r,t,s){let e=null,i=m();function n(){const h=f(t)?[t]:t,o=r.toArray().find(d=>h.includes(d.kind)&&d.mode==="showing");if(o!==e){if(!o){s(null),e=null;return}o.readyState==2?s(o):(s(null),S(()=>{const d=u(o,"load",()=>{s(o),d()},{once:!0})},i)),e=o}}return n(),u(r,"mode-change",n)}function _(r,t,s){v(r,t,e=>{if(!e){s("");return}const i=()=>{const n=e?.activeCues[0];s(n?.text||"")};i(),u(e,"cue-change",i)})}class I extends T{static createId(t){return`vds-${t.type}-${t.kind}-${t.src??t.label??"?"}`}src;content;type;encoding;id="";label="";language="";kind;default=!1;#r=!1;#e=0;#i="disabled";#h={};#n=[];#t=[];#s=[];[a.readyState]=0;[a.crossOrigin];[a.onModeChange]=null;[a.native]=null;get metadata(){return this.#h}get regions(){return this.#n}get cues(){return this.#t}get activeCues(){return this.#s}get readyState(){return this[a.readyState]}get mode(){return this.#i}set mode(t){this.setMode(t)}constructor(t){super();for(const s of Object.keys(t))this[s]=t[s];this.type||(this.type="vtt"),t.content?this.#u(t):t.src||(this[a.readyState]=2)}addCue(t,s){let e=0,i=this.#t.length;for(e=0;e<i&&!(t.endTime<=this.#t[e].startTime);e++);e===i?this.#t.push(t):this.#t.splice(e,0,t),t instanceof TextTrackCue||this[a.native]?.track.addCue(t),this.dispatchEvent(new c("add-cue",{detail:t,trigger:s})),l(t,this.#e)&&this[a.updateActiveCues](this.#e,s)}removeCue(t,s){const e=this.#t.indexOf(t);if(e>=0){const i=this.#s.includes(t);this.#t.splice(e,1),this[a.native]?.track.removeCue(t),this.dispatchEvent(new c("remove-cue",{detail:t,trigger:s})),i&&this[a.updateActiveCues](this.#e,s)}}setMode(t,s){this.#i!==t&&(this.#i=t,t==="disabled"?(this.#s=[],this.#l()):this.readyState===2?this[a.updateActiveCues](this.#e,s):this.#o(),this.dispatchEvent(new c("mode-change",{detail:this,trigger:s})),this[a.onModeChange]?.())}[a.updateActiveCues](t,s){if(this.#e=t,this.mode==="disabled"||!this.#t.length)return;const e=[];for(let n=0,h=this.#t.length;n<h;n++){const o=this.#t[n];l(o,t)&&e.push(o)}let i=e.length!==this.#s.length;if(!i){for(let n=0;n<e.length;n++)if(!this.#s.includes(e[n])){i=!0;break}}this.#s=e,i&&this.#l(s)}[a.canLoad](){this.#r=!0,this.#i!=="disabled"&&this.#o()}#u(t){import("../captions/prod.js").then(({parseText:s,VTTCue:e,VTTRegion:i})=>{!f(t.content)||t.type==="json"?(this.#d(t.content,e,i),this.readyState!==3&&this.#a()):s(t.content,{type:t.type}).then(({cues:n,regions:h})=>{this.#t=n,this.#n=h,this.#a()})})}async#o(){if(!(!this.#r||this[a.readyState]>0)){if(this[a.readyState]=1,this.dispatchEvent(new c("load-start")),!this.src){this.#a();return}try{const{parseResponse:t,VTTCue:s,VTTRegion:e}=await import("https://cdn.vidstack.io/captions"),i=this[a.crossOrigin]?.(),n=fetch(this.src,{headers:this.type==="json"?{"Content-Type":"application/json"}:void 0,credentials:b(i)});if(this.type==="json")this.#d(await(await n).text(),s,e);else{const{errors:h,metadata:o,regions:d,cues:C}=await t(n,{type:this.type,encoding:this.encoding});if(h[0]?.code===0)throw h[0];this.#h=o,this.#n=d,this.#t=C}this.#a()}catch(t){this.#c(t)}}}#a(){if(this[a.readyState]=2,!this.src||this.type!=="vtt"){const s=this[a.native];if(s&&!s.managed)for(const e of this.#t)s.track.addCue(e)}const t=new c("load");this[a.updateActiveCues](this.#e,t),this.dispatchEvent(t)}#c(t){this[a.readyState]=3,this.dispatchEvent(new c("error",{detail:t}))}#d(t,s,e){try{const{regions:i,cues:n}=y(t,s,e);this.#n=i,this.#t=n}catch(i){this.#c(i)}}#l(t){this.dispatchEvent(new c("cue-change",{trigger:t}))}}const j=/captions|subtitles/;function D(r){return j.test(r.kind)}function y(r,t,s){const e=f(r)?JSON.parse(r):r;let i=[],n=[];return e.regions&&s&&(i=e.regions.map(h=>Object.assign(new s,h))),(e.cues||p(e))&&(n=(p(e)?e:e.cues).filter(h=>g(h.startTime)&&g(h.endTime)).map(h=>Object.assign(new t(0,0,""),h))),{regions:i,cues:n}}export{a as T,I as a,v as b,l as c,M as f,D as i,y as p,_ as w};
