@page "/blog/{*Permalink}"
@using Blazorise.Docs.BlogRuntime
@inject Blazorise.Docs.BlogRuntime.IBlogProvider BlogProvider

@if ( pageModel is null )
{
    <Div Margin="Margin.Is4.OnY">
        <Alert Color="Color.Danger" Visible>
            <AlertMessage>
                Post not found.
            </AlertMessage>
        </Alert>
    </Div>
}
else
{
    @pageModel.Content
}

@code {
    [Parameter] public string Permalink { get; set; } = string.Empty;

    BlogPageModel pageModel;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            // Build a canonical permalink for the provider:
            // if it already starts with /blog/, keep it; otherwise prefix /blog/
            var canonical = Canonicalize( Permalink );

            pageModel = await BlogProvider.GetByPermalinkAsync( canonical );
        }
        catch
        {
        }
    }

    private static string Canonicalize( string p )
    {
        var s = ( p ?? string.Empty ).Trim().Replace( '\\', '/' );

        if ( !s.StartsWith( "/" ) )
            s = "/" + s;

        if ( !s.StartsWith( "/blog/", StringComparison.OrdinalIgnoreCase ) )
            s = "/blog" + ( s == "/" ? "" : s );

        // collapse // and remove trailing slash (except root)
        while ( s.Contains( "//", StringComparison.Ordinal ) )
            s = s.Replace( "//", "/" );

        if ( s.Length > 1 && s.EndsWith( '/' ) )
            s = s.TrimEnd( '/' );

        return s;
    }
}