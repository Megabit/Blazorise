@namespace Blazorise.Docs.Docs.Examples

<DataGrid TItem="SelfReferenceEmployee"
          Data="@rootItems"
          ExpandTrigger="DataGridExpandTrigger.ToggleClick"
          ExpandRowTrigger="OnExpandRowTrigger"
          ReadChildData="OnReadChildData"
          Responsive
          ShowPager>
    <DataGridColumns>
        <DataGridColumn Field="@nameof( SelfReferenceEmployee.FullName )" Caption="Employee" Width="Width.Px( 300 )">
            <ExpandTemplate Context="row">
                <Span Display="Display.InlineFlex" VerticalAlignment="VerticalAlignment.Middle" TextOverflow="TextOverflow.NoWrap">
                    @if ( row.Level > 0 )
                    {
                        <Span Display="Display.InlineBlock" Width="@Width.Rem( row.Level )"></Span>
                    }

                    @if ( row.Expandable )
                    {
                        <Button Size="Size.ExtraSmall"
                                Color="Color.Light"
                                Margin="Margin.Is2.FromEnd"
                                Clicked="@(() => row.Toggle())">
                            <Icon Name="@(row.Expanded ? IconName.ChevronDown : IconName.ChevronRight)" />
                        </Button>
                    }
                    else
                    {
                        <Span Display="Display.InlineBlock" Width="@Width.Rem( 1 )" Margin="Margin.Is2.FromEnd"></Span>
                    }
                </Span>
            </ExpandTemplate>
            <DisplayTemplate Context="cell">
                <Span TextWeight="TextWeight.SemiBold">@cell.DisplayValue</Span>
            </DisplayTemplate>
        </DataGridColumn>
        <DataGridColumn Field="@nameof( SelfReferenceEmployee.City )" Caption="City" />
        <DataGridNumericColumn Field="@nameof( SelfReferenceEmployee.Salary )" Caption="Salary" DisplayFormat="{0:C}" />
    </DataGridColumns>
</DataGrid>

@code {
    [Inject] public EmployeeData EmployeeData { get; set; }

    private List<SelfReferenceEmployee> rootItems = new();
    private Dictionary<int, List<SelfReferenceEmployee>> childLookup = new();

    protected override async Task OnInitializedAsync()
    {
        var employees = ( await EmployeeData.GetDataAsync().ConfigureAwait( false ) ).Take( 24 ).ToList();
        BuildSelfReferenceData( employees );
        await base.OnInitializedAsync();
    }

    private void BuildSelfReferenceData( IReadOnlyList<Employee> employees )
    {
        var selfReferenceEmployees = employees.Select( x => new SelfReferenceEmployee
        {
            Id = x.Id,
            FullName = $"{x.FirstName} {x.LastName}",
            City = x.City,
            Salary = x.Salary,
        } ).ToList();

        var roots = selfReferenceEmployees.Take( 3 ).ToList();
        var levelOneNodes = new List<SelfReferenceEmployee>();
        var currentIndex = roots.Count;

        for ( var rootIndex = 0; rootIndex < roots.Count && currentIndex < selfReferenceEmployees.Count; rootIndex++ )
        {
            for ( var childIndex = 0; childIndex < 3 && currentIndex < selfReferenceEmployees.Count; childIndex++ )
            {
                var child = selfReferenceEmployees[currentIndex++];
                child.ParentId = roots[rootIndex].Id;
                levelOneNodes.Add( child );
            }
        }

        for ( var levelOneIndex = 0; levelOneIndex < levelOneNodes.Count && currentIndex < selfReferenceEmployees.Count; levelOneIndex++ )
        {
            for ( var childIndex = 0; childIndex < 2 && currentIndex < selfReferenceEmployees.Count; childIndex++ )
            {
                var child = selfReferenceEmployees[currentIndex++];
                child.ParentId = levelOneNodes[levelOneIndex].Id;
            }
        }

        childLookup = selfReferenceEmployees
            .Where( x => x.ParentId.HasValue )
            .GroupBy( x => x.ParentId!.Value )
            .ToDictionary( x => x.Key, x => x.ToList() );

        rootItems = selfReferenceEmployees.Where( x => !x.ParentId.HasValue ).ToList();
    }

    private bool OnExpandRowTrigger( DataGridExpandRowTriggerEventArgs<SelfReferenceEmployee> args )
    {
        args.Expandable = childLookup.ContainsKey( args.Item.Id );
        return true;
    }

    private void OnReadChildData( DataGridReadChildDataEventArgs<SelfReferenceEmployee> args )
    {
        args.Data = childLookup.TryGetValue( args.Item.Id, out var children )
            ? children
            : Enumerable.Empty<SelfReferenceEmployee>();
    }

    private sealed class SelfReferenceEmployee
    {
        public int Id { get; set; }

        public int? ParentId { get; set; }

        public string FullName { get; set; }

        public string City { get; set; }

        public decimal Salary { get; set; }
    }
}