@page "/tests/passwordstrength"
@using System
@using System.Linq

<Row>
    <Column ColumnSize="ColumnSize.IsFull.OnMobile.IsHalf.OnDesktop">
        <Card Margin="Margin.Is4.OnY">
            <CardHeader>
                <CardTitle>Passphrase-first defaults</CardTitle>
            </CardHeader>
            <CardBody>
                <CardText>
                    Uses security-oriented defaults: a minimum length of 15, blocked-password checks, and no forced composition rules.
                </CardText>
                <PasswordStrength @bind-Value="@passphrasePassword"
                                  Placeholder="Type a long passphrase"
                                  StrengthChanged="@OnDefaultStrengthChanged" />

                <Div Margin="Margin.Is3.FromTop">
                    <Span TextWeight="TextWeight.SemiBold">Level:</Span> @defaultStrengthLevel
                    <Span Margin="Margin.Is3.FromStart" TextWeight="TextWeight.SemiBold">Score:</Span> @defaultStrengthScore%
                </Div>
            </CardBody>
        </Card>
    </Column>

    <Column ColumnSize="ColumnSize.IsFull.OnMobile.IsHalf.OnDesktop">
        <Card Margin="Margin.Is4.OnY">
            <CardHeader>
                <CardTitle>Custom policy</CardTitle>
            </CardHeader>
            <CardBody>
                <CardText>
                    This sample enables a composition policy and a custom blocked-password list.
                </CardText>
                <PasswordStrength @bind-Value="@strictPassword"
                                  Title="Create a secure password"
                                  MinimumLength="12"
                                  RequireUppercase
                                  RequireLowercase
                                  RequireNumber
                                  RequireSpecialCharacter
                                  RequireNotCompromisedPassword
                                  BlockedPasswords="@customBlockedPasswords"
                                  StrengthChanged="@OnStrictStrengthChanged" />

                <Div Margin="Margin.Is3.FromTop">
                    <Span TextWeight="TextWeight.SemiBold">Level:</Span> @strictStrengthLevel
                    <Span Margin="Margin.Is3.FromStart" TextWeight="TextWeight.SemiBold">Score:</Span> @strictStrengthScore%
                    <Span Margin="Margin.Is3.FromStart" TextWeight="TextWeight.SemiBold">Rules:</Span> @strictPassedRules/@strictTotalRules
                </Div>
            </CardBody>
        </Card>
    </Column>
</Row>

<Row>
    <Column ColumnSize="ColumnSize.IsFull.OnDesktop.Is8">
        <Card Margin="Margin.Is4.OnY">
            <CardHeader>
                <CardTitle>Validation integration</CardTitle>
            </CardHeader>
            <CardBody>
                <CardText>
                    <Code>PasswordStrength</Code> integrates with <Code>Validation</Code> because it inherits from <Code>BaseTextInput&lt;string&gt;</Code>.
                </CardText>

                <Validations @ref="@validations" Mode="ValidationMode.Manual">
                    <Validation Validator="@ValidatePolicyPassword">
                        <Field>
                            <FieldLabel RequiredIndicator>Password</FieldLabel>
                            <FieldBody>
                                <PasswordStrength @bind-Value="@validatedPassword"
                                                  MinimumLength="12"
                                                  RequireUppercase
                                                  RequireLowercase
                                                  RequireNumber
                                                  RequireSpecialCharacter
                                                  ShowPasswordToggle>
                                    <Feedback>
                                        <ValidationError>Please enter a strong password that satisfies all configured rules.</ValidationError>
                                    </Feedback>
                                </PasswordStrength>
                            </FieldBody>
                        </Field>
                    </Validation>
                    <Button Color="Color.Primary" Clicked="@SubmitValidation">
                        Validate
                    </Button>
                </Validations>
            </CardBody>
        </Card>
    </Column>
</Row>

@code {
    private static readonly string[] customBlockedPasswords =
    [
        "P@ssw0rd",
        "Password123!",
        "LetMeIn!"
    ];

    private Validations validations;

    private string passphrasePassword;
    private string strictPassword;
    private string validatedPassword;

    private PasswordStrengthLevel defaultStrengthLevel;
    private int defaultStrengthScore;

    private PasswordStrengthLevel strictStrengthLevel;
    private int strictStrengthScore;
    private int strictPassedRules;
    private int strictTotalRules;

    private void OnDefaultStrengthChanged( PasswordStrengthChangedEventArgs eventArgs )
    {
        defaultStrengthLevel = eventArgs.StrengthLevel;
        defaultStrengthScore = eventArgs.Score;
    }

    private void OnStrictStrengthChanged( PasswordStrengthChangedEventArgs eventArgs )
    {
        strictStrengthLevel = eventArgs.StrengthLevel;
        strictStrengthScore = eventArgs.Score;
        strictPassedRules = eventArgs.PassedRules;
        strictTotalRules = eventArgs.TotalRules;
    }

    private void ValidatePolicyPassword( ValidatorEventArgs eventArgs )
    {
        string password = Convert.ToString( eventArgs.Value );

        if ( string.IsNullOrWhiteSpace( password ) )
        {
            eventArgs.Status = ValidationStatus.Error;
            return;
        }

        bool hasMinimumLength = password.Length >= 12;
        bool hasUppercase = password.Any( char.IsUpper );
        bool hasLowercase = password.Any( char.IsLower );
        bool hasNumber = password.Any( char.IsDigit );
        bool hasSpecialCharacter = password.Any( c => char.IsPunctuation( c ) || char.IsSymbol( c ) );

        bool isStrong = hasMinimumLength
            && hasUppercase
            && hasLowercase
            && hasNumber
            && hasSpecialCharacter;

        eventArgs.Status = isStrong
            ? ValidationStatus.Success
            : ValidationStatus.Error;
    }

    private Task SubmitValidation()
    {
        return validations.ValidateAll();
    }
}